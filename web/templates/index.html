<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="/static/index.css">
</head>
<body>
    <div class="layout">
        <aside class="sidebar left-sidebar">
            <h1>ğŸ“š {{ title }}</h1>
            <p class="sidebar-desc">ì‘ì—… íŒ¨ë„ (ìŠ¤ì¼ˆë ˆí†¤)</p>

            <section class="tool-box">
                <h2>ìºë¦­í„° ì‚¬ì „ ìƒì„±</h2>
                <label for="dict-provider">Provider</label>
                <select id="dict-provider">
                    <option>OpenAI</option>
                    <option>Google</option>
                    <option>Anthropic</option>
                </select>
                <label for="dict-model">Model</label>
                <select id="dict-model">
                    <option>gpt-4o-mini</option>
                    <option>gemini-2.0-flash</option>
                    <option>claude-3-5-sonnet</option>
                </select>
                <button type="button" class="action-btn">ìºë¦­í„° ì‚¬ì „ ìƒì„±</button>
            </section>

            <section class="tool-box">
                <h2>ë²ˆì—­</h2>
                <label for="translate-provider">Provider</label>
                <select id="translate-provider">
                    <option>OpenAI</option>
                    <option>Google</option>
                    <option>Anthropic</option>
                </select>
                <label for="translate-model">Model</label>
                <select id="translate-model">
                    <option>gpt-4o-mini</option>
                    <option>gemini-2.0-flash</option>
                    <option>claude-3-5-sonnet</option>
                </select>
                <button type="button" class="action-btn">ë²ˆì—­ ì‹œì‘</button>
            </section>
        </aside>

        <main class="main-panel">
            <section class="json-viewer">
                <h2>character_dictionary.json ë‚´ìš©</h2>
                <div id="json-content">
                    <p class="json-message">ì˜¤ë¥¸ìª½ì—ì„œ íŒŒì¼ì„ ì„ íƒí•˜ë©´ character_dictionary.json ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
            </section>
        </main>

        <aside class="sidebar right-sidebar">
            <section class="upload-container">
                <h2>íŒŒì¼ ì—…ë¡œë“œ ë° ì„ íƒ</h2>
                <p class="sidebar-desc">ë²ˆì—­í•  EPUB íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•´ ì—…ë¡œë“œí•˜ì„¸ìš”.</p>

                <div id="drop-zone">
                    <p>ğŸ“¥ ì—¬ê¸°ì— íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜, í´ë¦­í•´ì„œ ì„ íƒí•˜ì„¸ìš”</p>
                    <input type="file" id="file-input" accept=".epub">
                </div>

                <div id="result-msg"></div>

                <section class="uploaded-list">
                    <h3>ì—…ë¡œë“œëœ EPUB ëª©ë¡</h3>
                    {% set initial_files = uploaded_items if uploaded_items is defined else uploaded_files if uploaded_files is defined else [] %}
                    <ul id="uploaded-files">
                        {% if initial_files %}
                            {% for item in initial_files %}
                                {% set filename = item.filename if item is mapping else item %}
                                {% set has_dictionary = item.has_character_dictionary if item is mapping else true %}
                                <li>
                                    <span class="file-item" data-filename="{{ filename }}" data-has-dictionary="{{ 'true' if has_dictionary else 'false' }}">{{ filename }}</span>
                                </li>
                            {% endfor %}
                        {% else %}
                            <li class="empty">ì•„ì§ ì—…ë¡œë“œëœ EPUB íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>
                        {% endif %}
                    </ul>
                </section>
            </section>
        </aside>
    </div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const resultMsg = document.getElementById('result-msg');
        const uploadedFiles = document.getElementById('uploaded-files');
        const jsonContent = document.getElementById('json-content');
        let selectedFilename = null;

        function showJsonMessage(message, type = 'info') {
            jsonContent.innerHTML = '';
            const paragraph = document.createElement('p');
            paragraph.className = `json-message ${type}`;
            paragraph.textContent = message;
            jsonContent.appendChild(paragraph);
        }

        function createPrimitiveNode(value, path) {
            const valueNode = document.createElement('div');
            const dataType = value === null ? 'null' : typeof value;
            valueNode.className = `json-primitive type-${dataType}`;
            valueNode.dataset.path = path;

            if (value === null) {
                valueNode.textContent = 'null';
                return valueNode;
            }

            valueNode.textContent = String(value);
            return valueNode;
        }

        function createArrayNode(arrayValue, path) {
            const wrapper = document.createElement('ul');
            wrapper.className = 'json-array';
            wrapper.dataset.path = path;

            if (arrayValue.length === 0) {
                const emptyItem = document.createElement('li');
                emptyItem.className = 'json-empty';
                emptyItem.textContent = 'ë¹„ì–´ ìˆëŠ” ë¦¬ìŠ¤íŠ¸';
                wrapper.appendChild(emptyItem);
                return wrapper;
            }

            arrayValue.forEach((item, index) => {
                const row = document.createElement('li');
                row.className = 'json-array-item';

                const childPath = path ? `${path}.${index}` : String(index);

                const valueContainer = document.createElement('div');
                valueContainer.className = 'json-item-value';
                valueContainer.appendChild(renderJsonValue(item, childPath));

                row.appendChild(valueContainer);
                wrapper.appendChild(row);
            });

            return wrapper;
        }

        function createObjectNode(objectValue, path) {
            const wrapper = document.createElement('div');
            wrapper.className = 'json-object';
            wrapper.dataset.path = path;

            const entries = Object.entries(objectValue);
            if (entries.length === 0) {
                const emptyNode = document.createElement('div');
                emptyNode.className = 'json-empty';
                emptyNode.textContent = 'ë¹„ì–´ ìˆëŠ” ê°ì²´';
                wrapper.appendChild(emptyNode);
                return wrapper;
            }

            entries.forEach(([key, value]) => {
                const row = document.createElement('div');
                row.className = 'json-field';

                const keyNode = document.createElement('div');
                keyNode.className = 'json-field-key';
                keyNode.dataset.path = path ? `${path}.${key}` : key;
                keyNode.textContent = key;

                const childPath = path ? `${path}.${key}` : key;
                const valueContainer = document.createElement('div');
                valueContainer.className = 'json-field-value';
                valueContainer.appendChild(renderJsonValue(value, childPath));

                row.appendChild(keyNode);
                row.appendChild(valueContainer);
                wrapper.appendChild(row);
            });

            return wrapper;
        }

        function renderJsonValue(value, path = '') {
            if (Array.isArray(value)) {
                return createArrayNode(value, path);
            }

            if (value !== null && typeof value === 'object') {
                return createObjectNode(value, path);
            }

            return createPrimitiveNode(value, path);
        }

        function renderJsonContent(value) {
            jsonContent.innerHTML = '';
            const treeRoot = renderJsonValue(value, 'root');
            treeRoot.classList.add('json-root');
            jsonContent.appendChild(treeRoot);
        }

        // 1. ë°•ìŠ¤ í´ë¦­ ì‹œ ìˆ¨ê²¨ì§„ file-input ì‹¤í–‰
        dropZone.addEventListener('click', () => fileInput.click());

        // 2. ë¸Œë¼ìš°ì € ê¸°ë³¸ ë“œë˜ê·¸ ë™ì‘ ë§‰ê¸° (íŒŒì¼ì´ ë¸Œë¼ìš°ì €ì—ì„œ ì—´ë ¤ë²„ë¦¬ëŠ” ê²ƒ ë°©ì§€)
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

        // 3. ë“œë˜ê·¸ ì¤‘ì¼ ë•Œ ì‹œê°ì  í”¼ë“œë°± (ìƒ‰ìƒ ë³€ê²½)
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('hover'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('hover'), false);
        });

        // 4. ë“œë¡­(Drop) ë˜ëŠ” íŒŒì¼ ì„ íƒ(Change) ì‹œ ì²˜ë¦¬
        dropZone.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files));
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        function handleFiles(files) {
            if (files.length === 0) return;
            const file = files[0];
            
            // EPUB í™•ì¥ì ê²€ì‚¬
            if (!file.name.toLowerCase().endsWith('.epub')) {
                showMessage("ì˜¤ë¥˜: EPUB íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.", "error");
                return;
            }

            uploadFile(file);
        }

        // 5. ì„œë²„ë¡œ íŒŒì¼ ì „ì†¡ (Fetch API)
        function uploadFile(file) {
            showMessage(`ì—…ë¡œë“œ ì¤‘: ${file.name}...`, "success");
            
            const formData = new FormData();
            formData.append('file', file);

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showMessage(`âœ… ${data.message} (${data.filename})`, "success");
                    refreshUploadedFiles();
                } else {
                    showMessage(`âŒ ì—…ë¡œë“œ ì‹¤íŒ¨`, "error");
                }
            })
            .catch(error => {
                showMessage(`âŒ í†µì‹  ì—ëŸ¬: ${error}`, "error");
            });
        }

        // ë©”ì‹œì§€ ë„ìš°ëŠ” ìœ í‹¸ í•¨ìˆ˜
        function showMessage(text, type) {
            resultMsg.textContent = text;
            resultMsg.className = type;
            resultMsg.style.display = 'block';
        }

        function refreshUploadedFiles() {
            fetch('/uploads')
                .then(response => response.json())
                .then(data => {
                    if (data.status !== 'success') {
                        return;
                    }

                    uploadedFiles.innerHTML = '';

                    if (!data.files || data.files.length === 0) {
                        selectedFilename = null;
                        const li = document.createElement('li');
                        li.textContent = 'ì•„ì§ ì—…ë¡œë“œëœ EPUB íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.';
                        li.className = 'empty';
                        uploadedFiles.appendChild(li);
                        showJsonMessage('íŒŒì¼ì„ ì„ íƒí•˜ë©´ character_dictionary.json ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.');
                        return;
                    }

                    const previousSelectedFilename = selectedFilename;
                    selectedFilename = null;

                    data.files.forEach(fileItem => {
                        const isObjectItem = typeof fileItem === 'object' && fileItem !== null;
                        const filenameValue = isObjectItem ? fileItem.filename : fileItem;
                        const hasDictionary = isObjectItem ? !!fileItem.has_character_dictionary : true;

                        if (!filenameValue) {
                            return;
                        }

                        const li = document.createElement('li');
                        const fileItemElement = document.createElement('span');
                        fileItemElement.className = 'file-item';
                        fileItemElement.dataset.filename = filenameValue;
                        fileItemElement.dataset.hasDictionary = hasDictionary ? 'true' : 'false';
                        fileItemElement.textContent = filenameValue;

                        if (previousSelectedFilename === filenameValue) {
                            fileItemElement.classList.add('selected');
                            selectedFilename = filenameValue;
                        }

                        li.appendChild(fileItemElement);
                        uploadedFiles.appendChild(li);
                    });

                    if (!selectedFilename) {
                        showJsonMessage('íŒŒì¼ì„ ì„ íƒí•˜ë©´ character_dictionary.json ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.');
                    }
                })
                .catch(() => {
                    // ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ í™”ë©´ ìœ ì§€
                });
        }

        uploadedFiles.addEventListener('click', (e) => {
            const target = e.target;
            if (!(target instanceof Element)) {
                return;
            }

            const itemElement = target.closest('.file-item');
            if (!(itemElement instanceof HTMLElement)) {
                return;
            }

            const filename = itemElement.dataset.filename;
            if (!filename) {
                return;
            }

            if (selectedFilename === filename) {
                itemElement.classList.remove('selected');
                selectedFilename = null;
                showJsonMessage('ì„ íƒì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤. íŒŒì¼ì„ ì„ íƒí•˜ë©´ character_dictionary.json ë‚´ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤.');
                return;
            }

            uploadedFiles.querySelectorAll('.file-item.selected').forEach((element) => {
                element.classList.remove('selected');
            });
            itemElement.classList.add('selected');
            selectedFilename = filename;

            const hasDictionary = itemElement.dataset.hasDictionary === 'true';
            if (!hasDictionary) {
                showJsonMessage('ì´ íŒŒì¼ì—ëŠ” character_dictionary.jsonì´ ì—†ìŠµë‹ˆë‹¤.', 'warn');
                return;
            }

            showJsonMessage('JSONì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');

            fetch(`/character-dictionary?epub_filename=${encodeURIComponent(filename)}`)
                .then(response => response.json())
                .then(data => {
                    if (selectedFilename !== filename) {
                        return;
                    }

                    if (data.status !== 'success') {
                        showJsonMessage(`ì˜¤ë¥˜: ${data.message ?? 'JSONì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'}`, 'error');
                        return;
                    }

                    renderJsonContent(data.content);
                })
                .catch((error) => {
                    if (selectedFilename !== filename) {
                        return;
                    }
                    showJsonMessage(`í†µì‹  ì˜¤ë¥˜: ${error}`, 'error');
                });
        });

        refreshUploadedFiles();
    </script>
</body>
</html>